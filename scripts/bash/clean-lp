#!/bin/bash
# ┌────────────────────────────────────────────────────────┐
# │ Version         : 2026.02.15-01                        │
# │ Author          : Mark Hamilton & Copilot AI assisted  │
# │ Script Purpose  : Clean linPEAS output                 │
# │ Package         : toolbox                              │
# └────────────────────────────────────────────────────────┘
#
# Usage:
#   clean-lp <input-file> <output-file> [--dry-run] [--verbose]
#
# Examples:
#   clean-lp linpeas.log linpeas_clean.log
#   clean-lp linpeas.log linpeas_clean.log --verbose
#   clean-lp linpeas.log linpeas_clean.log --dry-run
#
# Description:
#   Removes ANSI escape codes and invalid UTF‑8 bytes from
#   linPEAS output. Produces a clean, analysis‑ready file
#   suitable for parsing, uploading, or long‑term storage.
#
# End Help

set -euo pipefail

TOOL_NAME="clean-lp"
VERSION="2026.02.15-01"

DRY_RUN=false
VERBOSE=false

INPUT_FILE=""
OUTPUT_FILE=""

# ─── Logging Helper ──────────────────────────────────────────
log() { $VERBOSE && echo "[LOG] $1"; }

# ─── Parse Args & Flags ──────────────────────────────────────
for arg in "$@"; do
    case "$arg" in
        --dry-run) DRY_RUN=true ;;
        --verbose) VERBOSE=true ;;
        *)
            if [[ -z "$INPUT_FILE" ]]; then
                INPUT_FILE="$arg"
            elif [[ -z "$OUTPUT_FILE" ]]; then
                OUTPUT_FILE="$arg"
            else
                echo "[ERROR] Unknown argument: $arg"
                exit 1
            fi
            ;;
    esac
done

# ─── Validation ──────────────────────────────────────────────
if [[ -z "$INPUT_FILE" || -z "$OUTPUT_FILE" ]]; then
    echo "Usage: $TOOL_NAME <input-file> <output-file> [--dry-run] [--verbose]"
    exit 1
fi

if [[ ! -f "$INPUT_FILE" ]]; then
    echo "[ERROR] Input file does not exist: $INPUT_FILE"
    exit 1
fi

# ─── Main Logic ──────────────────────────────────────────────
log "Running $TOOL_NAME version $VERSION"
log "Input : $INPUT_FILE"
log "Output: $OUTPUT_FILE"

if $DRY_RUN; then
    echo "[DRY-RUN] Would clean linPEAS output and write to $OUTPUT_FILE"
    exit 0
fi

log "Stripping ANSI escape codes and invalid UTF‑8…"

# ANSI escape removal + UTF‑8 sanitisation
sed -r $'s/\x1B\

\[[0-9;]*[mK]//g' "$INPUT_FILE" \
    | iconv -f utf-8 -t utf-8 -c \
    > "$OUTPUT_FILE"

echo "[OK] Cleaned linPEAS output written to: $OUTPUT_FILE"
