#!/bin/bash
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ Version        : 2026.02.13-01                        â”‚
# â”‚ Author         : Mark Hamilton â”‚ Co-Pilot AI assisted â”‚
# â”‚ Script Purpose : Systems Diagnostics & health tool.   â”‚
# â”‚ Package        : toolbox                              â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# Usage:
#   [sudo] diag [--dry-run] [--log] [--hashmap] [--network]
#
# Examples:
#   diag
#   sudo diag
#   diag --dry-run
#   diag --log --network
#   diag --hashmap
#
# Description:
#   Performs system diagnostics including uptime, memory, disk, and service
#   health checks. Optional flags enable:
#     â€¢ dry-run simulation
#     â€¢ logging to /var/log/diag.log
#     â€¢ network diagnostics
#     â€¢ hash-based traceability via .hashmap/
#
# Output Files:
#   /var/log/diag.log              (when --log is used)
#   .hashmap/diag.hash             (when --hashmap is used)
#   .hashmap/diag.timestamp        (when --hashmap is used)
#
# End Help

set -e

LOG=false
DRY_RUN=false
HASHMAP=false
NETWORK=false

while [[ "$#" -gt 0 ]]; do
    case "$1" in
        --dry-run) DRY_RUN=true ;;
        --log) LOG=true ;;
        --hashmap) HASHMAP=true ;;
        --network) NETWORK=true ;;
        --help)
            echo "Usage: diag [--dry-run] [--log] [--hashmap] [--network]"
            exit 0 ;;
        *) echo "Unknown option: $1"; exit 1 ;;
    esac
    shift
done

diagnostics=(
    "uptime"
    "df -h"
    "free -m"
    "top -b -n 1 | head -20"
    "systemctl --failed"
    "dmesg | tail -20"
)

if $NETWORK; then
    diagnostics+=(
        "ip a"
        "ip r"
        "ss -tuln"
        "cat /etc/resolv.conf"
        "systemctl status NetworkManager"
    )
fi

echo "ğŸ” Running system diagnostics..."
for check in "${diagnostics[@]}"; do
    if $DRY_RUN; then
        echo "[DRY-RUN] Would run: $check"
    else
        echo "ğŸ“Œ Running: $check"
        echo "â–¶ $check"
        eval "$check"
        echo ""
    fi
done

if $LOG && ! $DRY_RUN; then
    LOGFILE="/var/log/diag.log"
    echo "ğŸ“ Logging to $LOGFILE"
    {
        echo "=== diag ==="
        date
        for check in "${diagnostics[@]}"; do
            echo "â–¶ $check"
            eval "$check"
            echo ""
        done
        echo "========================"
    } >> "$LOGFILE"
fi

if $HASHMAP; then
    mkdir -p .hashmap
    sha256sum "$0" > .hashmap/diag.hash
    date > .hashmap/diag.timestamp
    echo "ğŸ” Hashmap written to .hashmap/diag.hash and .hashmap/diag.timestamp"
fi

echo "âœ… Diagnostics complete."
